name: Build and Release DMG

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if commit is version bump
        id: check_commit
        run: |
          COMMIT_MSG=$(git log -1 --pretty=%B)
          if [[ "$COMMIT_MSG" == "Bump version to"* ]]; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "This is a version bump commit, skipping workflow"
          else
            echo "skip=false" >> $GITHUB_OUTPUT
            echo "This is a regular commit, proceeding with release"
          fi

      - name: Get current version and increment
        if: steps.check_commit.outputs.skip == 'false'
        id: version
        run: |
          CURRENT_VERSION=$(/usr/libexec/PlistBuddy -c "Print :CFBundleShortVersionString" ClipClap/Info.plist)
          CURRENT_BUILD=$(/usr/libexec/PlistBuddy -c "Print :CFBundleVersion" ClipClap/Info.plist)

          echo "Current version: $CURRENT_VERSION (build $CURRENT_BUILD)"

          if git tag | grep -q "^v${CURRENT_VERSION}$"; then
            IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
            MAJOR="${VERSION_PARTS[0]}"
            MINOR="${VERSION_PARTS[1]:-0}"
            PATCH="${VERSION_PARTS[2]:-0}"
            PATCH=$((PATCH + 1))
            NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          else
            NEW_VERSION="$CURRENT_VERSION"
          fi

          NEW_BUILD=$((CURRENT_BUILD + 1))

          echo "New version: $NEW_VERSION (build $NEW_BUILD)"
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "build=$NEW_BUILD" >> $GITHUB_OUTPUT

          /usr/libexec/PlistBuddy -c "Set :CFBundleShortVersionString $NEW_VERSION" ClipClap/Info.plist
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $NEW_BUILD" ClipClap/Info.plist

      - name: Setup export options
        if: steps.check_commit.outputs.skip == 'false'
        run: |
          cat > /tmp/ExportOptions.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>method</key>
              <string>mac-application</string>
              <key>compileBitcode</key>
              <false/>
              <key>stripSwiftSymbols</key>
              <true/>
          EOF

          if [ -n "${{ secrets.APPLE_TEAM_ID }}" ]; then
            cat >> /tmp/ExportOptions.plist << 'EOF'
              <key>signingStyle</key>
              <string>automatic</string>
              <key>teamID</key>
              <string>${{ secrets.APPLE_TEAM_ID }}</string>
          EOF
          fi

          cat >> /tmp/ExportOptions.plist << 'EOF'
          </dict>
          </plist>
          EOF

          cat /tmp/ExportOptions.plist

      - name: Build app
        if: steps.check_commit.outputs.skip == 'false'
        run: |
          xcodebuild -project ClipClap.xcodeproj \
            -scheme ClipClap \
            -configuration Release \
            -derivedDataPath build \
            -archivePath build/ClipClap.xcarchive \
            archive \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

          xcodebuild -exportArchive \
            -archivePath build/ClipClap.xcarchive \
            -exportPath build/Export \
            -exportOptionsPlist /tmp/ExportOptions.plist

      - name: Create DMG
        if: steps.check_commit.outputs.skip == 'false'
        run: |
          brew install create-dmg

          VERSION="${{ steps.version.outputs.version }}"
          APP_PATH="build/Export/ClipClap.app"
          DMG_NAME="ClipClap-${VERSION}.dmg"

          create-dmg \
            --volname "ClipClap" \
            --volicon "${APP_PATH}/Contents/Resources/AppIcon.icns" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "ClipClap.app" 200 190 \
            --hide-extension "ClipClap.app" \
            --app-drop-link 600 185 \
            "${DMG_NAME}" \
            "${APP_PATH}" \
            || true

          if [ ! -f "${DMG_NAME}" ]; then
            echo "create-dmg failed, using hdiutil fallback"
            mkdir -p dmg-temp
            cp -R "${APP_PATH}" dmg-temp/
            hdiutil create -volname "ClipClap" -srcfolder dmg-temp -ov -format UDZO "${DMG_NAME}"
            rm -rf dmg-temp
          fi

          echo "DMG created: ${DMG_NAME}"
          ls -lh "${DMG_NAME}"

      - name: Commit version bump
        if: steps.check_commit.outputs.skip == 'false'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add ClipClap/Info.plist
          git commit -m "Bump version to ${{ steps.version.outputs.version }} (build ${{ steps.version.outputs.build }})"
          git tag "v${{ steps.version.outputs.version }}"

      - name: Push changes and tags
        if: steps.check_commit.outputs.skip == 'false'
        run: |
          git push origin HEAD:main
          git push origin "v${{ steps.version.outputs.version }}"

      - name: Create GitHub Release
        if: steps.check_commit.outputs.skip == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          BUILD="${{ steps.version.outputs.build }}"

          cat > release-notes.md <<'NOTES'
          ## ClipClap v${VERSION}

          **Installation:**
          1. Download the DMG file below
          2. Open the DMG
          3. Drag ClipClap to your Applications folder
          4. Launch ClipClap from Applications
          5. Grant accessibility permissions when prompted

          **What's New:**
          - Automated release build ${BUILD}

          **System Requirements:**
          - macOS 12.0 (Monterey) or later
          NOTES

          gh release create "v${VERSION}" \
            "ClipClap-${VERSION}.dmg" \
            --title "ClipClap v${VERSION}" \
            --notes-file release-notes.md
